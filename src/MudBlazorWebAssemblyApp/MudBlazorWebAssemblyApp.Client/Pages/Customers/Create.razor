@page "/customers/create"
@inject IAsyncCustomerService Api
@inject IAsyncRegionService RegionApi
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudText Typo="Typo.h3">Create Customer</MudText>

@if (regions is null )
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <EditForm Model="@customer" FormName="CustomerForm" OnValidSubmit="@OnValidSubmit">
        
        <Blazored.FluentValidation.FluentValidationValidator />

        <MudGrid>
            <MudItem xs="12" sm="7">
                <MudCard>
                    <MudCardContent>
                        <MudTextField Label="Nazwa" @bind-Value=@customer.Name For="@(() => customer.Name)" />
                        <MudTextField Label="Email" @bind-Value=@customer.Email For="@(() => customer.Email)" />
                        <MudCheckBox Label="Archiwalny" @bind-Value=@customer.IsArchived Color="Color.Primary" />

                        <MudSelect T="Region" Label="Region" @bind-Value=@customer.Region>
                            @foreach (var region in regions!)
                            {
                                <MudSelectItem Value="region">@region.Name</MudSelectItem>
                            }
                        </MudSelect>

                        <MudTextField Label="Kod klienta" @bind-Value=@customer.Code For="@(() => customer.Code)" />
                        <MudDatePicker Label="Data urodzenia" @bind-Date=@customer.Birthday For="@(() => customer.Birthday)" />
                        <MudNumericField Label="Dochód" @bind-Value=@customer.Salary For="@(() => customer.Salary)" />

                        <MudTextField Label="Hasło" @bind-Value=@customer.Password For="@(() => customer.Password)" />
                        <MudTextField Label="Powtorz hasło" @bind-Value=@customer.ConfirmPassword For="@(() => customer.ConfirmPassword)" />

                        <MudSwitch Label="Zgoda na NewsLeter" @bind-Value="@customer.Newsletter" Color="Color.Primary"
                                   For="@(() => customer.Newsletter)" />

                    </MudCardContent>

                    <MudCardActions>
                        <MudButton ButtonType="ButtonType.Submit" Color="Color.Primary" Variant="Variant.Filled">Zapisz</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>
    </EditForm>
}

@code {
    
    private Customer customer = new Customer();

    private List<Region>? regions;

    protected override async Task OnInitializedAsync()
    {
        regions = await RegionApi.GetAll();
    }    

    private async Task OnValidSubmit(EditContext context)
    {
        try
        {
            await Api.Add(customer!);

            Snackbar.Add($"Dodano klienta {customer!.Name}", Severity.Success);

            Nav.NavigateTo("/customers");
        }
        catch (Exception e)
        {
            Snackbar.Add(e.Message, Severity.Error);
        }
    }

}
